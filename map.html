
<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0"/>

<title>Zip Decode</title>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="queue.min.js"></script>

<style type="text/css">
body {
    margin: 0;
    font-family: Helvetica, Arial, sans-serif; font-size: 12px;
    overflow: hidden;
}
#states { fill: none; stroke: #aaa; stroke-width: 0.5px; }
#selBox { font-size: 36px; }
</style>

</head><body>

<div id="map"></div>
<div id="selBox">Selected: <span id="selected"></span></div>

<script type="text/javascript">
var width = 1200,
    height = 600;


var proj = d3.geo.albersUsa().scale(1200)
    .translate([width / 2, height / 2]);

var path = d3.geo.path().projection(proj);

queue()
    .defer(d3.json, "us-states.geojson")
    .defer(d3.tsv, "zips.tsv")
    .await(render);


var selectedZip = "";
function key() {
    var code = d3.event.keyCode;

    console.log(code);

    if (code == 32) {
        // Space: clear code
        updateSelection("");
    } else if (code == 37) {
        // Left arrow: remove one letter
        // FIXME: grab backspace too (suppress navigaton)
        if (selectedZip.length > 0) {
            updateSelection(selectedZip.substr(0, selectedZip.length - 1));
        }
    } else if (code >= 48 && code <= 57) {
        // 0..9: add that to the zip if possible
        if (selectedZip.length < 5) {
            updateSelection(selectedZip + String.fromCharCode(code));
        }
    }
    return false;
};

function updateSelection(n) {
    selectedZip = n;
    d3.select("#selected").text(selectedZip);
}

function render(error, states, zips) {
    var svg = d3.select("#map").append("svg")
        .attr("width", width)
        .attr("height", height);

    svg.append("g").attr("id", "states");

    d3.select("#states").selectAll("path")
        .data(states.features)
      .enter().append("path")
        .attr("d", path);

    svg.append("g").attr("id", "zipdots");
    d3.select("#zipdots").selectAll("rect")
        .data(zips)
      .enter().append("rect")
        .attr("x", function(d) { var p = proj([d.lon, d.lat]); return p[0]; })
        .attr("y", function(d) { var p = proj([d.lon, d.lat]); return p[1];  })
        .attr("width", 1).attr("height", 1);

    d3.select("body").on("keydown", key);
};
</script>
</body></html>
